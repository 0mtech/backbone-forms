(function(){var a=Backbone.Form,b=a.editors;b.List=b.Base.extend({className:"bbf-list",events:{'click [data-action="add"]':function(a){a.preventDefault(),this.addItem()}},initialize:function(a){b.Base.prototype.initialize.call(this,a);var c=this.schema;if(!c)throw"Missing required option 'schema'";this.Editor=function(){var a=c.itemType;return a?b.List[a]?b.List[a]:b[a]:b.Text}(),this.items=[]},render:function(){var b=this,c=this.$el,d=this.value||[];return c.html(a.templates.list({items:'<b class="bbf-tmp"></b>'})),this.$list=c.find(".bbf-tmp").parent().empty(),d.length?_.each(d,function(a){b.addItem(a)}):this.Editor.isAsync||this.addItem(),this},addItem:function(a){var c=this,d=(new b.List.Item({list:this,schema:this.schema,value:a,Editor:this.Editor})).render();this.Editor.isAsync?d.editor.on("readyToAdd",function(){c.items.push(d),c.$list.append(d.el)}):(this.items.push(d),this.$list.append(d.el))},removeItem:function(a){var b=this.schema.confirmDelete;if(b&&!confirm(b))return;var c=_.indexOf(this.items,a);this.items[c].remove(),this.items.splice(c,1),!this.items.length&&!this.Editor.isAsync&&this.addItem()},getValue:function(){var a=_.map(this.items,function(a){return a.getValue()});return _.without(a,undefined,"")},setValue:function(a){this.value=a,this.render()},remove:function(){_.invoke(this.items,"remove"),b.Base.prototype.remove.call(this)},validate:function(){if(!this.validators)return null;var a=_.map(this.items,function(a){return a.validate()}),b=_.compact(a).length?!0:!1;if(!b)return null;var c={type:"list",message:"Some of the items in the list failed validation",errors:a};return c}}),b.List.Item=Backbone.View.extend({events:{'click [data-action="remove"]':function(a){a.preventDefault(),this.list.removeItem(this)}},initialize:function(a){this.list=a.list,this.schema=a.schema||this.list.schema,this.value=a.value,this.Editor=a.Editor||b.Text},render:function(){this.editor=(new this.Editor({key:"",schema:this.schema,value:this.value,list:this.list,item:this})).render();var b=$(a.templates.listItem({editor:'<b class="bbf-tmp"></b>'}));return b.find(".bbf-tmp").replaceWith(this.editor.el),this.setElement(b),this},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){var b=this.getValue(),c=this.list.form?this.list.form.getValue():{},d=this.schema.validators,e=a.helpers.getValidator;if(!d)return null;var f=null;return _.every(d,function(a){return f=e(a)(b,c),continueLoop=f?!1:!0}),f?this.setError(f):this.clearError(),f?f:null},setError:function(b){this.$el.addClass(a.classNames.error),this.$el.attr("title",b.message)},clearError:function(){this.$el.removeClass(a.classNames.error),this.$el.attr("title",null)}}),b.List.Modal=b.List.Object=b.List.NestedModel=b.Base.extend({events:{click:"openEditor"},initialize:function(a){b.Base.prototype.initialize.call(this,a);var c=this.schema;if(!b.List.Modal.ModalAdapter)throw"A ModalAdapter is required";if(c.itemType=="Object"){if(!c.subSchema)throw'Missing required option "schema.subSchema"';this.nestedSchema=c.subSchema}if(c.itemType=="NestedModel"){if(!c.model)throw'Missing required option "schema.model"';this.nestedSchema=c.model.prototype.schema,_.isFunction(this.nestedSchema)&&(this.nestedSchema=this.nestedSchema())}},render:function(){var a=this;return _.isEmpty(this.value)?this.openEditor():(this.renderSummary(),setTimeout(function(){a.trigger("readyToAdd")},0)),this},renderSummary:function(){var b=a.templates["list.Modal"];this.$el.html(b({summary:this.getStringValue()}))},itemToString:function(b){b=b||{};var c=[];return _.each(this.nestedSchema,function(d,e){var f=d.title?d.title:a.helpers.keyToTitle(e),g=b[e];if(_.isUndefined(g)||_.isNull(g))g="";c.push(f+": "+g)}),c.join("<br />")},getStringValue:function(){var a=this.schema,b=this.getValue();return _.isEmpty(b)?"[Empty]":a.itemToString?a.itemToString(b):a.itemType=="NestedModel"?(new a.model(b)).toString():this.itemToString(b)},openEditor:function(){var b=this,c=new a({schema:this.nestedSchema,data:this.value}),d=(new Backbone.BootstrapModal({content:c,animate:!0})).open();d.on("ok",_.bind(this.onModalSubmitted,this,c,d))},onModalSubmitted:function(a,b){var c=_.isEmpty(this.value),d=a.validate();if(d)return b.preventClose();this.value=a.getValue(),this.renderSummary(),c&&this.trigger("readyToAdd")},getValue:function(){return this.value},setValue:function(a){this.value=a}},{ModalAdapter:Backbone.BootstrapModal,isAsync:!0})})()