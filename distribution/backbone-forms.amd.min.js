define(["jquery","Backbone"],function(a,b){var c=function(){return b.View.extend({initialize:function(a){if(!c.templates.form)throw new Error("Templates not loaded");this.schema=function(){if(a.schema)return a.schema;var b=a.model;if(!b)throw new Error("Could not find schema");return _.isFunction(b.schema)?b.schema():b.schema}(),a=_.extend({template:"form",fieldsetTemplate:"fieldset",fieldTemplate:"field"},a);if(!a.fieldsets){var b=a.fields||_.keys(this.schema);a.fieldsets=[{fields:b}]}this.options=a,this.model=a.model,this.data=a.data,this.fields={}},render:function(){var b=this,d=this.options,e=c.templates[d.template],f=a(e({fieldsets:'<b class="bbf-tmp"></b>'})),g=a(".bbf-tmp",f);return _.each(d.fieldsets,function(a){g.append(b.renderFieldset(a))}),g.children().unwrap(),this.setElement(f),this},renderFieldset:function(b){var d=this,e=c.templates[this.options.fieldsetTemplate],f=this.schema,g=c.helpers.getNested;_.isArray(b)&&(b={fields:b});var h=a(e(_.extend({},b,{legend:b.legend||"",fields:'<b class="bbf-tmp"></b>'}))),i=a(".bbf-tmp",h);return _.each(b.fields,function(a){var b=function(){if(f[a])return f[a];var b=a.replace(/\./g,".subSchema.");return g(f,b)}();if(!b)throw"Field '"+a+"' not found in schema";var e=d.fields[a]=d.createField(a,b);f.type=="Hidden"?e.editor=c.helpers.createEditor("Hidden",options):i.append(e.render().el)}),i=i.children().unwrap(),h},createField:function(a,b){var d={form:this,key:a,schema:b,idPrefix:this.options.idPrefix};return this.model?d.model=this.model:this.data?d.value=this.data[a]:d.value=null,new c.Field(d)},validate:function(){var a=this,b=this.fields,c=this.model,d={};_.each(b,function(a){var b=a.validate();b&&(d[a.key]=b)});if(c&&c.validate){var e=c.validate(this.getValue());if(e){var f=_.isObject(e)&&!_.isArray(e);f||(d._others=d._others||[],d._others.push(e)),f&&_.each(e,function(b,c){if(a.fields[c]&&!d[c])a.fields[c].setError(b);else{d._others=d._others||[];var e={};e[c]=b,d._others.push(e)}})}}return _.isEmpty(d)?null:d},commit:function(){var a=this.validate();if(a)return a;var b;this.model.set(this.getValue(),{error:function(a,c){b=c}});if(b)return b},getValue:function(a){if(a)return this.fields[a].getValue();var b={};return _.each(this.fields,function(a){b[a.key]=a.getValue()}),b},setValue:function(a){for(var b in a)this.fields[b].setValue(a[b])},remove:function(){var a=this.fields;for(var c in a)a[c].remove();b.View.prototype.remove.call(this)}})}();return c.helpers=function(){var a={};return a.getNested=function(a,b){var c=b.split("."),d=a;for(var e=0,f=c.length;e<f;e++)d=d[c[e]];return d},a.keyToTitle=function(a){return a=a.replace(/([A-Z])/g," $1"),a=a.replace(/^./,function(a){return a.toUpperCase()}),a},a.compileTemplate=function(a){var b=_.templateSettings.interpolate;_.templateSettings.interpolate=/\{\{(.+?)\}\}/g;var c=_.template(a);return _.templateSettings.interpolate=b,c},a.createTemplate=function(b,c){var d=a.compileTemplate(b);return c?d(c):d},a.setTemplateCompiler=function(b){a.compileTemplate=b},a.setTemplates=function(b,d){var e=a.createTemplate;c.templates=c.templates||{},c.classNames=c.classNames||{},_.each(b,function(a,b,d){_.isString(a)&&(a=e(a)),c.templates[b]=a}),_.extend(c.classNames,d)},a.createEditor=function(a,b){var d;return _.isString(a)?d=c.editors[a]:d=a,new d(b)},a.triggerCancellableEvent=function(a,b,c,d){if(!a._callbacks||!a._callbacks[b])return d();var e=a._callbacks[b].next;if(!e)return d();var f=e.callback,g=e.context||this;c.push(d),f.apply(g,c)},a.getValidator=function(a){var b=c.validators;if(_.isRegExp(a))return b.regexp({regexp:a});if(_.isString(a)){if(!b[a])throw new Error('Validator "'+a+'" not found');return b[a]()}if(_.isFunction(a))return a;if(_.isObject(a)&&a.type){var d=a;return b[d.type](d)}throw new Error("Invalid validator: "+a)},a}(),c.validators=function(){var a={};return a.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:'Must match field "{{field}}"'},a.required=function(a){return a=_.extend({type:"required",message:this.errMessages.required},a),function(d){a.value=d;var e={type:a.type,message:c.helpers.createTemplate(a.message,a)};if(d===null||d===undefined||d==="")return e}},a.regexp=function(a){if(!a.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return a=_.extend({type:"regexp",message:this.errMessages.regexp},a),function(d){a.value=d;var e={type:a.type,message:c.helpers.createTemplate(a.message,a)};if(d===null||d===undefined||d==="")return;if(!a.regexp.test(d))return e}},a.email=function(b){return b=_.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},b),a.regexp(b)},a.url=function(b){return b=_.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i},b),a.regexp(b)},a.match=function(a){if(!a.field)throw new Error('Missing required "field" options for "match" validator');return a=_.extend({type:"match",message:this.errMessages.match},a),function(d,e){a.value=d;var f={type:a.type,message:c.helpers.createTemplate(a.message,a)};if(d===null||d===undefined||d==="")return;if(d!=e[a.field])return f}},a}(),c.Field=function(){var d=c.helpers,e=c.templates;return b.View.extend({initialize:function(a){a=a||{},this.form=a.form,this.key=a.key,this.value=a.value,this.model=a.model,_.isString(a.schema)&&(a.schema={type:a.schema}),this.schema=_.extend({type:"Text",title:d.keyToTitle(this.key),template:"field"},a.schema)},render:function(){var b=this.schema,e=c.templates,f={form:this.form,key:this.key,schema:b,idPrefix:this.options.idPrefix,id:this.getId()};this.model?f.model=this.model:f.value=this.value;var g=this.editor=d.createEditor(b.type,f),h=a(e[b.template]({key:this.key,title:b.title,id:g.id,type:b.type,editor:'<b class="bbf-tmp-editor"></b>',help:'<b class="bbf-tmp-help"></b>'}));return h.find(".bbf-tmp-editor").replaceWith(g.render().el),this.$help=a(".bbf-tmp-help",h).parent(),this.$help.empty(),this.schema.help&&this.$help.html(this.schema.help),this.schema.fieldClass&&h.addClass(this.schema.fieldClass),this.schema.fieldAttrs&&h.attr(this.schema.fieldAttrs),this.setElement(h),this},getId:function(){var a=this.options.idPrefix,b=this.key;return b=b.replace(/\./g,"_"),_.isString(a)||_.isNumber(a)?a+b:_.isNull(a)?b:this.model?this.model.cid+"_"+b:b},validate:function(){var a=this.editor.validate();return a?this.setError(a.message):this.clearError(),a},setError:function(a){if(this.editor.hasNestedForm)return;var b=c.classNames.error;this.$el.addClass(b),this.$help&&this.$help.html(a)},clearError:function(){var a=c.classNames.error;this.$el.removeClass(a);if(this.$help){this.$help.empty();var b=this.schema.help;b&&this.$help.html(b)}},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},remove:function(){this.editor.remove(),b.View.prototype.remove.call(this)}})}(),c.editors=function(){var d=c.helpers,e={};return e.Base=b.View.extend({defaultValue:null,initialize:function(a){var a=a||{};if(a.model){if(!a.key)throw"Missing option: 'key'";this.model=a.model,this.key=a.key,this.value=this.model.get(this.key)}else a.value&&(this.value=a.value);this.value===undefined&&(this.value=this.defaultValue),this.form=a.form,this.schema=a.schema||{},this.validators=a.validators||this.schema.validators,this.$el.attr("name",this.getName()),this.schema.editorClass&&this.$el.addClass(this.schema.editorClass),this.schema.editorAttrs&&this.$el.attr(this.schema.editorAttrs)},getValue:function(){throw"Not implemented. Extend and override this method."},setValue:function(){throw"Not implemented. Extend and override this method."},getName:function(){var a=this.key||"";return a.replace(/\./g,"_")},commit:function(){var a=this.validate();if(a)return a;this.model.set(this.key,this.getValue(),{error:function(b,c){a=c}});if(a)return a},validate:function(){var a=this.$el,b=null,d=this.getValue(),e=this.form?this.form.getValue():{},f=this.validators,g=c.helpers.getValidator;return f&&_.every(f,function(a){return b=g(a)(d,e),continueLoop=b?!1:!0}),b}}),e.Text=e.Base.extend({tagName:"input",defaultValue:"",initialize:function(a){e.Base.prototype.initialize.call(this,a);var b=this.schema,c="text";b&&b.editorAttrs&&b.editorAttrs.type&&(c=b.editorAttrs.type),b&&b.dataType&&(c=b.dataType),this.$el.attr("type",c)},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.val()},setValue:function(a){this.$el.val(a)}}),e.Number=e.Text.extend({defaultValue:0,events:{keypress:"onKeyPress"},initialize:function(a){e.Text.prototype.initialize.call(this,a),this.$el.attr("type","number")},onKeyPress:function(a){if(a.charCode==0)return;var b=this.$el.val()+String.fromCharCode(a.charCode),c=/^[0-9]*\.?[0-9]*?$/.test(b);c||a.preventDefault()},getValue:function(){var a=this.$el.val();return a===""?null:parseFloat(a,10)},setValue:function(a){a=function(){return _.isNumber(a)?a:_.isString(a)&&a!==""?parseFloat(a,10):null}(),_.isNaN(a)&&(a=null),e.Text.prototype.setValue.call(this,a)}}),e.Password=e.Text.extend({initialize:function(a){e.Text.prototype.initialize.call(this,a),this.$el.attr("type","password")}}),e.TextArea=e.Text.extend({tagName:"textarea"}),e.Checkbox=e.Base.extend({defaultValue:!1,tagName:"input",initialize:function(a){e.Base.prototype.initialize.call(this,a),this.$el.attr("type","checkbox")},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.attr("checked")?!0:!1},setValue:function(a){a&&this.$el.attr("checked",!0)}}),e.Hidden=e.Base.extend({defaultValue:"",initialize:function(a){e.Text.prototype.initialize.call(this,a),this.$el.attr("type","hidden")},getValue:function(){return this.value},setValue:function(a){this.value=a}}),e.Select=e.Base.extend({tagName:"select",initialize:function(a){e.Base.prototype.initialize.call(this,a);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){var a=this.schema.options,c=this;if(a instanceof b.Collection){var d=a;d.length>0?c.renderOptions(a):d.fetch({success:function(b){c.renderOptions(a)}})}else _.isFunction(a)?a(function(a){c.renderOptions(a)}):c.renderOptions(a);return this},renderOptions:function(a){var c=this.$el,d;_.isString(a)?d=a:_.isArray(a)?d=this._arrayToHtml(a):a instanceof b.Collection&&(d=this._collectionToHtml(a)),c.html(d),this.setValue(this.value)},getValue:function(){return this.$el.val()},setValue:function(a){this.$el.val(a)},_collectionToHtml:function(a){var b=[];a.each(function(a){b.push({val:a.id,label:a.toString()})});var c=this._arrayToHtml(b);return c},_arrayToHtml:function(a){var b=[];return _.each(a,function(a){if(_.isObject(a)){var c=a.val?a.val:"";b.push('<option value="'+c+'">'+a.label+"</option>")}else b.push("<option>"+a+"</option>")}),b.join("")}}),e.Radio=e.Select.extend({tagName:"ul",className:"bbf-radio",getValue:function(){return this.$el.find("input[type=radio]:checked").val()},setValue:function(a){this.$el.find("input[type=radio][value="+a+"]").attr("checked",!0)},_arrayToHtml:function(a){var b=[],c=this;return _.each(a,function(a,d){var e="<li>";if(_.isObject(a)){var f=a.val?a.val:"";e+='<input type="radio" name="'+c.id+'" value="'+f+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a.label+"</label>"}else e+='<input type="radio" name="'+c.id+'" value="'+a+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a+"</label>";e+="</li>",b.push(e)}),b.join("")}}),e.Checkboxes=e.Select.extend({tagName:"ul",className:"bbf-checkboxes",getValue:function(){var b=[];return this.$el.find("input[type=checkbox]:checked").each(function(){b.push(a(this).val())}),b},setValue:function(a){var b=this;_.each(a,function(a){b.$el.find('input[type=checkbox][value="'+a+'"]').attr("checked",!0)})},_arrayToHtml:function(a){var b=[],c=this;return _.each(a,function(a,d){var e="<li>";if(_.isObject(a)){var f=a.val?a.val:"";e+='<input type="checkbox" name="'+c.id+'" value="'+f+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a.label+"</label>"}else e+='<input type="checkbox" name="'+c.id+'" value="'+a+'" id="'+c.id+"-"+d+'" />',e+='<label for="'+c.id+"-"+d+'">'+a+"</label>";e+="</li>",b.push(e)}),b.join("")}}),e.Object=e.Base.extend({hasNestedForm:!0,className:"bbf-object",defaultValue:{},initialize:function(a){e.Base.prototype.initialize.call(this,a);if(!this.schema.subSchema)throw"Missing required 'schema.subSchema' option for Object editor"},render:function(){var a=this.$el,b=this.value||{},d=this.key,e=this.schema,f=e.subSchema;return _.each(f,function(a){a.template||(a.template="nestedField")}),this.form=new c({schema:f,data:b,idPrefix:this.id+"_"}),a.html(this.form.render().el),this},getValue:function(){return this.form.getValue()},setValue:function(a){this.value=a,this.render()},remove:function(){this.form.remove(),b.View.prototype.remove.call(this)},validate:function(){return this.form.validate()}}),e.NestedModel=e.Object.extend({initialize:function(a){e.Base.prototype.initialize.call(this,a);if(!a.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var a=this.value||{},b=this.key,d=this.schema.model,e=d.prototype.schema;return _.isFunction(e)&&(e=e()),_.each(e,function(a){a.template||(a.template="nestedField")}),this.form=new c({schema:e,model:new d(a),idPrefix:this.id+"_"}),this.$el.html(this.form.render().el),this},commit:function(){var a=this.form.commit();return a?(this.$el.addClass("error"),a):e.Object.prototype.commit.call(this)}}),e.List=e.Base.extend({className:"bbf-list",events:{'click *[data-action="add"]':function(a){a.preventDefault(),this.addItem()}},initialize:function(a){e.Base.prototype.initialize.call(this,a);if(!this.schema)throw"Missing required option 'schema'";this.schema.listType=this.schema.listType||"Text",this.items=[]},render:function(){var a=this,b=this.$el,d=this.value||[];return b.html(c.templates.list({items:'<b class="bbf-tmp"></b>'})),this.$list=b.find(".bbf-tmp").parent().empty(),d.length?_.each(d,function(b){a.addItem(b)}):this.addItem(),this},addItem:function(a){var b=new e.List.Item({list:this,schema:this.schema,value:a});this.items.push(b),this.$list.append(b.render().el)},removeItem:function(a){var b=this.schema.confirmDelete;if(b&&!confirm(b))return;var c=_.indexOf(this.items,a);this.items[c].remove(),this.items.splice(c,1),this.items.length||this.addItem()},getValue:function(){var a=_.map(this.items,function(a){return a.getValue()});return _.without(a,undefined,"")},setValue:function(a){this.value=a,this.render()},remove:function(){_.invoke(this.items,"remove"),e.Base.prototype.remove.call(this)},validate:function(){if(!this.validators)return null;var a=_.map(this.items,function(a){return a.validate()}),b=_.compact(a).length?!0:!1;if(!b)return null;var c={type:"list",message:"Some of the items in the list failed validation",errors:a};return c}}),e.List.Item=b.View.extend({events:{'click *[data-action="remove"]':function(a){a.preventDefault(),this.list.removeItem(this)}},initialize:function(a){this.list=a.list,this.schema=a.schema||this.list.schema,this.value=a.value},render:function(){this.editor=c.helpers.createEditor(this.schema.listType,{key:"",schema:this.schema,value:this.value});var b=a(c.templates.listItem({editor:'<b class="bbf-tmp"></b>'}));return b.find(".bbf-tmp").replaceWith(this.editor.render().el),this.setElement(b),this},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},remove:function(){this.editor.remove(),b.View.prototype.remove.call(this)},validate:function(){var a=this.getValue(),b=this.list.form?this.list.form.getValue():{},d=this.schema.validators,e=c.helpers.getValidator;if(!d)return null;var f=null;return _.every(d,function(c){return f=e(c)(a,b),continueLoop=f?!1:!0}),f?this.setError(f):this.clearError(),f?f:null},setError:function(a){this.$el.addClass(c.classNames.error),this.$el.attr("title",a.message)},clearError:function(){this.$el.removeClass(c.classNames.error),this.$el.attr("title",null)}}),e.Date=e.Base.extend({className:"bbf-date",initialize:function(a){a=a||{},e.Base.prototype.initialize.call(this,a);var b=e.Date,c=new Date;this.options=_.extend({monthNames:b.monthNames,showMonthNames:b.showMonthNames},a),this.schema=_.extend({yearStart:c.getFullYear()-100,yearEnd:c.getFullYear()},a.schema||{}),this.value&&!_.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var d=new Date;d.setSeconds(0),d.setMilliseconds(0),this.value=d}},render:function(){var a=this.options,b=this.schema,d=_.map(_.range(1,32),function(a){return'<option value="'+a+'">'+a+"</option>"}),e=_.map(_.range(0,12),function(b){var c=a.showMonthNames?a.monthNames[b]:b+1;return'<option value="'+b+'">'+c+"</option>"}),f=_.map(_.range(b.yearStart,b.yearEnd+1),function(a){return'<option value="'+a+'">'+a+"</option>"});return this.$el.html(c.templates.date({dates:d.join(""),months:e.join(""),years:f.join("")})),this.$date=this.$('[data-type="date"]'),this.$month=this.$('[data-type="month"]'),this.$year=this.$('[data-type="year"]'),this.setValue(this.value),this},getValue:function(){return new Date(this.$year.val(),this.$month.val(),this.$date.val())},setValue:function(a){this.$date.val(a.getDate()),this.$month.val(a.getMonth()),this.$year.val(a.getFullYear())}},{showMonthNames:!0,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]}),e.DateTime=e.Base.extend({className:"bbf-datetime",initialize:function(a){a=a||{},e.Base.prototype.initialize.call(this,a),this.options=_.extend({DateEditor:e.DateTime.DateEditor},a),this.schema=_.extend({minsInterval:15},a.schema||{}),this.dateEditor=new this.options.DateEditor(a),this.value=this.dateEditor.value},render:function(){function a(a){return a<10?"0"+a:a}var b=this.schema,d=_.map(_.range(0,24),function(b){return'<option value="'+b+'">'+a(b)+"</option>"}),e=_.map(_.range(0,60,b.minsInterval),function(b){return'<option value="'+b+'">'+a(b)+"</option>"});return this.$el.append(c.templates.dateTime({date:'<b class="bbf-tmp"></b>',hours:d.join(),mins:e.join()})),this.$(".bbf-tmp").replaceWith(this.dateEditor.render().el),this.$hour=this.$('[data-type="hour"]'),this.$min=this.$('[data-type="min"]'),this.setValue(this.value),this},getValue:function(){var a=this.dateEditor.getValue();return a.setHours(this.$hour.val()),a.setMinutes(this.$min.val()),a},setValue:function(a){this.dateEditor.setValue(a),this.$hour.val(a.getHours()),this.$min.val(a.getMinutes())}},{DateEditor:e.Date}),e}(),c.setTemplates=c.helpers.setTemplates,c.setTemplateCompiler=c.helpers.setTemplateCompiler,c.templates={},c})