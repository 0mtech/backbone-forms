define(["jquery","underscore","Backbone"],function(e,t,n){var r=function(){return n.View.extend({initialize:function(e){if(!r.templates.form)throw new Error("Templates not loaded");this.schema=function(){if(e.schema)return e.schema;var n=e.model;if(!n)throw new Error("Could not find schema");return t.isFunction(n.schema)?n.schema():n.schema}(),e=t.extend({template:"form",fieldsetTemplate:"fieldset",fieldTemplate:"field"},e);if(!e.fieldsets){var n=e.fields||t.keys(this.schema);e.fieldsets=[{fields:n}]}this.options=e,this.model=e.model,this.data=e.data,this.fields={}},render:function(){var n=this,i=this.options,s=r.templates[i.template],o=e(s({fieldsets:'<b class="bbf-tmp"></b>'})),u=e(".bbf-tmp",o);return t.each(i.fieldsets,function(e){u.append(n.renderFieldset(e))}),u.children().unwrap(),this.setElement(o),this},renderFieldset:function(n){var i=this,s=r.templates[this.options.fieldsetTemplate],o=this.schema,u=r.helpers.getNested;t.isArray(n)&&(n={fields:n});var a=e(s(t.extend({},n,{legend:'<b class="bbf-tmp-legend"></b>',fields:'<b class="bbf-tmp-fields"></b>'})));n.legend?a.find(".bbf-tmp-legend").replaceWith(n.legend):a.find(".bbf-tmp-legend").parent().remove();var f=e(".bbf-tmp-fields",a);return t.each(n.fields,function(e){var t=function(){if(o[e])return o[e];var t=e.replace(/\./g,".subSchema.");return u(o,t)}();if(!t)throw"Field '"+e+"' not found in schema";var n=i.fields[e]=i.createField(e,t),r=n.render().el;t.type!="Hidden"&&f.append(r)}),f=f.children().unwrap(),a},createField:function(e,t){t.template=t.template||this.options.fieldTemplate;var n={form:this,key:e,schema:t,idPrefix:this.options.idPrefix,template:this.options.fieldTemplate};return this.model?n.model=this.model:this.data?n.value=this.data[e]:n.value=null,new r.Field(n)},validate:function(){var e=this,n=this.fields,r=this.model,i={};t.each(n,function(e){var t=e.validate();t&&(i[e.key]=t)});if(r&&r.validate){var s=r.validate(this.getValue());if(s){var o=t.isObject(s)&&!t.isArray(s);o||(i._others=i._others||[],i._others.push(s)),o&&t.each(s,function(t,n){if(e.fields[n]&&!i[n])e.fields[n].setError(t);else{i._others=i._others||[];var r={};r[n]=t,i._others.push(r)}})}}return t.isEmpty(i)?null:i},commit:function(){var e=this.validate();if(e)return e;var t;this.model.set(this.getValue(),{error:function(e,n){t=n}});if(t)return t},getValue:function(e){if(e)return this.fields[e].getValue();var n={};return t.each(this.fields,function(e){n[e.key]=e.getValue()}),n},setValue:function(e){for(var t in e)this.fields[t].setValue(e[t])},remove:function(){var e=this.fields;for(var t in e)e[t].remove();n.View.prototype.remove.call(this)}})}();return r.helpers=function(){var e={};return e.getNested=function(e,t){var n=t.split("."),r=e;for(var i=0,s=n.length;i<s;i++)r=r[n[i]];return r},e.keyToTitle=function(e){return e=e.replace(/([A-Z])/g," $1"),e=e.replace(/^./,function(e){return e.toUpperCase()}),e},e.compileTemplate=function(e){var n=t.templateSettings.interpolate;t.templateSettings.interpolate=/\{\{(.+?)\}\}/g;var r=t.template(e);return t.templateSettings.interpolate=n,r},e.createTemplate=function(t,n){var r=e.compileTemplate(t);return n?r(n):r},e.setTemplateCompiler=function(t){e.compileTemplate=t},e.setTemplates=function(n,i){var s=e.createTemplate;r.templates=r.templates||{},r.classNames=r.classNames||{},t.each(n,function(e,n,i){t.isString(e)&&(e=s(e)),r.templates[n]=e}),t.extend(r.classNames,i)},e.createEditor=function(e,n){var i;return t.isString(e)?i=r.editors[e]:i=e,new i(n)},e.triggerCancellableEvent=function(e,t,n,r){if(!e._callbacks||!e._callbacks[t])return r();var i=e._callbacks[t].next;if(!i)return r();var s=i.callback,o=i.context||this;n.push(r),s.apply(o,n)},e.getValidator=function(e){var n=r.validators;if(t.isRegExp(e))return n.regexp({regexp:e});if(t.isString(e)){if(!n[e])throw new Error('Validator "'+e+'" not found');return n[e]()}if(t.isFunction(e))return e;if(t.isObject(e)&&e.type){var i=e;return n[i.type](i)}throw new Error("Invalid validator: "+e)},e}(),r.validators=function(){var e={};return e.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:'Must match field "{{field}}"'},e.required=function(e){return e=t.extend({type:"required",message:this.errMessages.required},e),function(n){e.value=n;var i={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n==="")return i}},e.regexp=function(e){if(!e.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return e=t.extend({type:"regexp",message:this.errMessages.regexp},e),function(n){e.value=n;var i={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n==="")return;if(!e.regexp.test(n))return i}},e.email=function(n){return n=t.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},n),e.regexp(n)},e.url=function(n){return n=t.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i},n),e.regexp(n)},e.match=function(e){if(!e.field)throw new Error('Missing required "field" options for "match" validator');return e=t.extend({type:"match",message:this.errMessages.match},e),function(n,i){e.value=n;var s={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n==="")return;if(n!=i[e.field])return s}},e}(),r.Field=function(){var i=r.helpers,s=r.templates;return n.View.extend({initialize:function(e){e=e||{},this.form=e.form,this.key=e.key,this.value=e.value,this.model=e.model,t.isString(e.schema)&&(e.schema={type:e.schema}),this.schema=t.extend({type:"Text",title:i.keyToTitle(this.key),template:"field"},e.schema)},render:function(){var t=this.schema,n=r.templates,s={form:this.form,key:this.key,schema:t,idPrefix:this.options.idPrefix,id:this.getId()};this.model?s.model=this.model:s.value=this.value;var o=this.editor=i.createEditor(t.type,s),u=e(n[t.template]({key:this.key,title:t.title,id:o.id,type:t.type,editor:'<b class="bbf-tmp-editor"></b>',help:'<b class="bbf-tmp-help"></b>'}));return u.find(".bbf-tmp-editor").replaceWith(o.render().el),this.$help=e(".bbf-tmp-help",u).parent(),this.$help.empty(),this.schema.help&&this.$help.html(this.schema.help),this.schema.fieldClass&&u.addClass(this.schema.fieldClass),this.schema.fieldAttrs&&u.attr(this.schema.fieldAttrs),this.setElement(u),this},getId:function(){var e=this.options.idPrefix,n=this.key;return n=n.replace(/\./g,"_"),t.isString(e)||t.isNumber(e)?e+n:t.isNull(e)?n:this.model?this.model.cid+"_"+n:n},validate:function(){var e=this.editor.validate();return e?this.setError(e.message):this.clearError(),e},setError:function(e){if(this.editor.hasNestedForm)return;var t=r.classNames.error;this.$el.addClass(t),this.$help&&this.$help.html(e)},clearError:function(){var e=r.classNames.error;this.$el.removeClass(e);if(this.$help){this.$help.empty();var t=this.schema.help;t&&this.$help.html(t)}},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},remove:function(){this.editor.remove(),n.View.prototype.remove.call(this)}})}(),r.editors=function(){var i=r.helpers,s={};return s.Base=n.View.extend({defaultValue:null,initialize:function(e){var e=e||{};if(e.model){if(!e.key)throw"Missing option: 'key'";this.model=e.model,this.value=this.model.get(e.key)}else e.value&&(this.value=e.value);this.value===undefined&&(this.value=this.defaultValue),this.key=e.key,this.form=e.form,this.schema=e.schema||{},this.validators=e.validators||this.schema.validators,this.$el.attr("name",this.getName()),this.schema.editorClass&&this.$el.addClass(this.schema.editorClass),this.schema.editorAttrs&&this.$el.attr(this.schema.editorAttrs)},getValue:function(){throw"Not implemented. Extend and override this method."},setValue:function(){throw"Not implemented. Extend and override this method."},getName:function(){var e=this.key||"";return e.replace(/\./g,"_")},commit:function(){var e=this.validate();if(e)return e;this.model.set(this.key,this.getValue(),{error:function(t,n){e=n}});if(e)return e},validate:function(){var e=this.$el,n=null,i=this.getValue(),s=this.form?this.form.getValue():{},o=this.validators,u=r.helpers.getValidator;return o&&t.every(o,function(e){return n=u(e)(i,s),continueLoop=n?!1:!0}),n}}),s.Text=s.Base.extend({tagName:"input",defaultValue:"",initialize:function(e){s.Base.prototype.initialize.call(this,e);var t=this.schema,n="text";t&&t.editorAttrs&&t.editorAttrs.type&&(n=t.editorAttrs.type),t&&t.dataType&&(n=t.dataType),this.$el.attr("type",n)},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)}}),s.Number=s.Text.extend({defaultValue:0,events:{keypress:"onKeyPress"},initialize:function(e){s.Text.prototype.initialize.call(this,e),this.$el.attr("type","number")},onKeyPress:function(e){if(e.charCode==0)return;var t=this.$el.val()+String.fromCharCode(e.charCode),n=/^[0-9]*\.?[0-9]*?$/.test(t);n||e.preventDefault()},getValue:function(){var e=this.$el.val();return e===""?null:parseFloat(e,10)},setValue:function(e){e=function(){return t.isNumber(e)?e:t.isString(e)&&e!==""?parseFloat(e,10):null}(),t.isNaN(e)&&(e=null),s.Text.prototype.setValue.call(this,e)}}),s.Password=s.Text.extend({initialize:function(e){s.Text.prototype.initialize.call(this,e),this.$el.attr("type","password")}}),s.TextArea=s.Text.extend({tagName:"textarea"}),s.Checkbox=s.Base.extend({defaultValue:!1,tagName:"input",initialize:function(e){s.Base.prototype.initialize.call(this,e),this.$el.attr("type","checkbox")},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.attr("checked")?!0:!1},setValue:function(e){e&&this.$el.attr("checked",!0)}}),s.Hidden=s.Base.extend({defaultValue:"",initialize:function(e){s.Text.prototype.initialize.call(this,e),this.$el.attr("type","hidden")},getValue:function(){return this.value},setValue:function(e){this.value=e}}),s.Select=s.Base.extend({tagName:"select",initialize:function(e){s.Base.prototype.initialize.call(this,e);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){var e=this.schema.options,r=this;if(e instanceof n.Collection){var i=e;i.length>0?r.renderOptions(e):i.fetch({success:function(t){r.renderOptions(e)}})}else t.isFunction(e)?e(function(e){r.renderOptions(e)}):r.renderOptions(e);return this},renderOptions:function(e){var r=this.$el,i;t.isString(e)?i=e:t.isArray(e)?i=this._arrayToHtml(e):e instanceof n.Collection&&(i=this._collectionToHtml(e)),r.html(i),this.setValue(this.value)},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)},_collectionToHtml:function(e){var t=[];e.each(function(e){t.push({val:e.id,label:e.toString()})});var n=this._arrayToHtml(t);return n},_arrayToHtml:function(e){var n=[];return t.each(e,function(e){if(t.isObject(e)){var r=e.val?e.val:"";n.push('<option value="'+r+'">'+e.label+"</option>")}else n.push("<option>"+e+"</option>")}),n.join("")}}),s.Radio=s.Select.extend({tagName:"ul",className:"bbf-radio",getValue:function(){return this.$el.find("input[type=radio]:checked").val()},setValue:function(e){this.$el.find("input[type=radio][value="+e+"]").attr("checked",!0)},_arrayToHtml:function(e){var n=[],r=this;return t.each(e,function(e,i){var s="<li>";if(t.isObject(e)){var o=e.val?e.val:"";s+='<input type="radio" name="'+r.id+'" value="'+o+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="radio" name="'+r.id+'" value="'+e+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e+"</label>";s+="</li>",n.push(s)}),n.join("")}}),s.Checkboxes=s.Select.extend({tagName:"ul",className:"bbf-checkboxes",getValue:function(){var t=[];return this.$el.find("input[type=checkbox]:checked").each(function(){t.push(e(this).val())}),t},setValue:function(e){var n=this;t.each(e,function(e){n.$el.find('input[type=checkbox][value="'+e+'"]').attr("checked",!0)})},_arrayToHtml:function(e){var n=[],r=this;return t.each(e,function(e,i){var s="<li>";if(t.isObject(e)){var o=e.val?e.val:"";s+='<input type="checkbox" name="'+r.id+'" value="'+o+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="checkbox" name="'+r.id+'" value="'+e+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e+"</label>";s+="</li>",n.push(s)}),n.join("")}}),s.Object=s.Base.extend({hasNestedForm:!0,className:"bbf-object",initialize:function(e){this.value={},s.Base.prototype.initialize.call(this,e);if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){return this.form=new r({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",fieldTemplate:"nestedField"}),this.$el.html(this.form.render().el),this},getValue:function(){return this.form?this.form.getValue():this.value},setValue:function(e){this.value=e,this.render()},remove:function(){this.form.remove(),n.View.prototype.remove.call(this)},validate:function(){return this.form.validate()}}),s.NestedModel=s.Object.extend({initialize:function(e){s.Base.prototype.initialize.call(this,e);if(!e.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var e=this.value||{},n=this.key,i=this.schema.model,s=i.prototype.schema;return t.isFunction(s)&&(s=s()),this.form=new r({schema:s,model:new i(e),idPrefix:this.id+"_",fieldTemplate:"nestedField"}),this.$el.html(this.form.render().el),this},commit:function(){var e=this.form.commit();return e?(this.$el.addClass("error"),e):s.Object.prototype.commit.call(this)}}),s.Date=s.Base.extend({events:{"change select":"updateHidden"},initialize:function(e){e=e||{},s.Base.prototype.initialize.call(this,e);var n=s.Date,r=new Date;this.options=t.extend({monthNames:n.monthNames,showMonthNames:n.showMonthNames},e),this.schema=t.extend({yearStart:r.getFullYear()-100,yearEnd:r.getFullYear()},e.schema||{}),this.value&&!t.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var i=new Date;i.setSeconds(0),i.setMilliseconds(0),this.value=i}},render:function(){var n=this.options,i=this.schema,s=t.map(t.range(1,32),function(e){return'<option value="'+e+'">'+e+"</option>"}),o=t.map(t.range(0,12),function(e){var t=n.showMonthNames?n.monthNames[e]:e+1;return'<option value="'+e+'">'+t+"</option>"}),u=t.map(t.range(i.yearStart,i.yearEnd+1),function(e){return'<option value="'+e+'">'+e+"</option>"}),a=e(r.templates.date({dates:s.join(""),months:o.join(""),years:u.join("")}));return this.$date=a.find('[data-type="date"]'),this.$month=a.find('[data-type="month"]'),this.$year=a.find('[data-type="year"]'),this.$hidden=e('<input type="hidden" name="'+this.key+'" />'),a.append(this.$hidden),this.setValue(this.value),this.setElement(a),this.$el.attr("id",this.id),this},getValue:function(){var e=this.$year.val(),t=this.$month.val(),n=this.$date.val();return!e||!t||!n?null:new Date(e,t,n)},setValue:function(e){this.$date.val(e.getDate()),this.$month.val(e.getMonth()),this.$year.val(e.getFullYear()),this.updateHidden()},updateHidden:function(){var e=this.getValue();t.isDate(e)&&(e=e.toISOString()),this.$hidden.val(e)}},{showMonthNames:!0,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]}),s.DateTime=s.Base.extend({events:{"change select":"updateHidden"},initialize:function(e){e=e||{},s.Base.prototype.initialize.call(this,e),this.options=t.extend({DateEditor:s.DateTime.DateEditor},e),this.schema=t.extend({minsInterval:15},e.schema||{}),this.dateEditor=new this.options.DateEditor(e),this.value=this.dateEditor.value},render:function(){function n(e){return e<10?"0"+e:e}var i=this.schema,s=t.map(t.range(0,24),function(e){return'<option value="'+e+'">'+n(e)+"</option>"}),o=t.map(t.range(0,60,i.minsInterval),function(e){return'<option value="'+e+'">'+n(e)+"</option>"}),u=e(r.templates.dateTime({date:'<b class="bbf-tmp"></b>',hours:s.join(),mins:o.join()}));return u.find(".bbf-tmp").replaceWith(this.dateEditor.render().el),this.$hour=u.find('[data-type="hour"]'),this.$min=u.find('[data-type="min"]'),this.$hidden=u.find('input[type="hidden"]'),this.setValue(this.value),this.setElement(u),this.$el.attr("id",this.id),this},getValue:function(){var e=this.dateEditor.getValue(),t=this.$hour.val(),n=this.$min.val();return!e||!t||!n?null:(e.setHours(t),e.setMinutes(n),e)},setValue:function(e){t.isDate(e)||(e=new Date(e)),this.dateEditor.setValue(e),this.$hour.val(e.getHours()),this.$min.val(e.getMinutes()),this.updateHidden()},updateHidden:function(){var e=this.getValue();t.isDate(e)&&(e=e.toISOString()),this.$hidden.val(e)},remove:function(){this.dateEditor.remove(),s.Base.prototype.remove.call(this)}},{DateEditor:s.Date}),s}(),r.setTemplates=r.helpers.setTemplates,r.setTemplateCompiler=r.helpers.setTemplateCompiler,r.templates={},r.setTemplates({form:'      <form class="bbf-form">{{fieldsets}}</form>    ',fieldset:"      <fieldset>        <legend>{{legend}}</legend>        <ul>{{fields}}</ul>      </fieldset>    ",field:'      <li class="bbf-field field-{{key}}">        <label for="{{id}}">{{title}}</label>        <div class="bbf-editor">{{editor}}</div>        <div class="bbf-help">{{help}}</div>      </li>    ',nestedField:'      <li class="bbf-field bbf-nested-field field-{{key}}" title="{{title}}">        <label for="{{id}}">{{title}}</label>        <div class="bbf-editor">{{editor}}</div>        <div class="bbf-help">{{help}}</div>      </li>    ',list:'      <div class="bbf-list">        <ul>{{items}}</ul>        <div class="bbf-actions"><button data-action="add">Add</div>      </div>    ',listItem:'      <li>        <button data-action="remove" class="bbf-remove">&times;</button>        <div class="bbf-editor-container">{{editor}}</div>      </li>    ',date:'      <div class="bbf-date">        <select data-type="date" class="bbf-date">{{dates}}</select>        <select data-type="month" class="bbf-month">{{months}}</select>        <select data-type="year" class="bbf-year">{{years}}</select>      </div>    ',dateTime:'      <div class="bbf-datetime">        <div class="bbf-date-container">{{date}}</div>        <select data-type="hour">{{hours}}</select>        :        <select data-type="min">{{mins}}</select>      </div>    ',"list.Modal":'      <div class="bbf-list-modal">        {{summary}}      </div>    '},{error:"bbf-error"}),r})